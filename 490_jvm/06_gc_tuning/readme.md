# GC调优方法概述



## 1 GC调优相关的概念

### 1.1 调优目标 

(1) `吞吐量`：用户代码执行时间 / (用户代码执行时间 + 垃圾回收时间)

(2) `响应时间`：`STW`(Stop The World)时间越短，响应时间越好

首先要确定调优的目标：吞吐量优先？还是响应时间优先？还是在满足一定响应时间的情况下要达到多少的吞吐量，例如：

> 科学计算，数据挖掘：吞吐量优先、一般使用垃圾回收器`PS + PO`即可
>
> 网站、GUI、API：响应时间优先，一般会用1.8 G1或其他优化响应时间的垃圾回收器

### 1.2 什么是调优

> 1.根据需求进行JVM规划和预调优
>
> 2.优化运行JVM运行环境
>
> 3.解决JVM运行过程中出现的各种问题（例如OOM等）

### 1.3 调优规划

从业务场景出发、没有业务场景的调优都是耍流氓；无监控（压力测试、能看到结果）不调优

步骤：

1. 熟悉业务场景、选定合适的垃圾回收器（响应时间、吞吐量）组合

2. 计算内存需求（内存小回收频繁但回收快，内存大回收少但有可能卡顿会变高）

3. 选定CPU（越高越好，核的数量影响到回收的并发能力，计算速度影响到回收速度）

4. 设计年代大小、升级年龄

5. 设定日志参数（例子如下，5个文件循环使用，用满时最早的1个文件被替换，文件太大查问题困难）或者每天产生一个日志文件

   > ~~~bash
   > -Xloggc:/opt/xxx/logs/xxx-xxx-gc-%t.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=20M -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCCause
   > ~~~

6. 观察日志情况

## 2 调优规划和预调优

### 例子1：订单系统用什么样配置的机器做压测

> 峰值每日订单量上限 → 推算日内高峰期每秒订单量 → 结合 (1) 单笔订单内存 (2) 响应时间要求及响应时间上限 → 推算出这些订单占用的内存 （还要结合其他内存的占用）→ 推算出总内存占用量

### 例子2：如何支撑大并发流量系统（100万并发）的抢票功能

> CDN -> LVS -> NGINX -> 业务系统 -> 每台机器1万（单机10K问题）并发 * 100台机器
>
> 一笔交易：【下单 -> 订单系统（IO）减库存 -> 等待用户付款】
>
> * 普通系统：当做一个事务
> * 高并发系统的一种可能的模型：异步
>   * 线程（1）负责减库存
>   * 线程（2）将下单信息放入队列或Redis中，等待付款
>   * 线程（3）订单处理线程取付款数据、持久化订单数据到HBase或MySQL
> * 库存服务器的负载均衡、数据倾斜问题解决

具体问题具体分析，要深入业务逻辑

## 3 优化JVM运行环境 

> 例如解决系统卡顿、CPU100%、内存飙升等

### 例子1：50万PV资料类网站，服务器从32位1.5G堆升级到64位16G堆时发生严重卡顿

> 原网站慢的原因：大量数据load到内存、内存不足频繁GC、STW编程，响应时间变慢
>
> 升级后卡顿的原因：内存越大Full GC时间越长 
>
> 解决办法：回收器换成`Parallel New` + `CMS` 或者 `G1`

### 例子2：系统CPU经常100%、如何调优

> CPU 100%：说明一定有线程在占用系统资源
>
> 1. 找出哪个进程CPU高：`top`命令
> 2. 找出该进程中哪个线程CPU高：`top -Hp`命令
> 3. （如果是java程序）导出该线程的堆栈、看看它都在调用什么：`jstack`
> 4. 查找哪个方法（栈帧）消耗时间：`jstack`
>
> 具体的使用方法在下面的demo中列出

### 例子3：系统内存飙高、如何调优

> 内存飙高，一定是堆内存飙高
>
> 1. 导出堆内存（`jmap`)
> 2. 分析（`jhat`, `jvisual vm`,`mat`, `jprofiler`……等工具）

### 例子4：如何监控JVM

> `jstat`, `jvisualvm`, `jprofiler`,`arthas`,`top` ……

