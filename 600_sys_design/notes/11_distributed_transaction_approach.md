[TOC]

# 分布式事务协议

## 1. 2PC：两阶段提交

### (1) 事务执行过程

> 角色：事务协调器，事务参与方
>
> 阶段一：协调器请求参与方在本地事务中进行预执行（precommit），记录undo和redo日志并汇报结果
>
> 阶段二：事务协调器确认预执行情况，要求所有参与方提交或回滚本地事务

### (2) 优缺点

> 优点：尽量保证了数据一致性，实现成本低（可以直接借助数据库的分布式事务）
>
> 缺点：
>
> * 单点故障：事务管理器是单点
> * 同步阻塞：阶段1执行之后，资源管理器中的资源（例如DB行）处于阻塞状态，直至阶段2的提交或回滚完成才能释放资源，无法用于高并发场景
> * 数据不一致的可能性仍然存在：例如阶段2的commit请求没有发送到所有的参与者，部分参与者处于阻塞状态，同时数据也处于不一致状态

### (3) 实现参考

> 各大主流数据库都有自己的实现，MySQL从5.5开始支持2PC

## 2. 3PC：三阶段提交

> 角色：事务协调器，事务参与方
>
> 阶段一：协调器询问参与方是否可以提交，需得到全部的ACK确认
>
> 阶段二：协调器请求参与方进行预执行（precommit）
>
> * 参与方在各自的本地事务中执行操作，并记录undo和redo日志
> * 参与方向协调器汇报执行结果：成功或失败
>
> 阶段三：协调器确认事务
>
> * 如果有参与方预执行失败：协调器告诉参与方放弃事务不要提交
> * 如果参与方全部预执行成功：
>     * 协调器通知所有参与方COMMIT本地事务
>     * 如果有一个参与方提交失败，协调器要求所有参与方回滚

## 3. TCC

> 基于业务层

## 4. 应用消息队列 + 消息表：实现最终一致性

> 

## 5. Sega事务

> 

## 6. Seata

> 